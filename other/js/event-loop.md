# 事件循环

js引擎是单线程的，同一时间只允许执行一个代码块。即将运行的代码块会按顺序放在任务队列（job queue）中。当js引擎中代码执行完后，事件循环会执行任务队列的下一个任务。事件循环是js引擎的一段程序，负责监控代码执行并管理任务队列。

## 浏览器里进程和线程

浏览器以前是单进程多线程，但这样会引起如果一个tab页面崩溃，会造成整个浏览器都崩溃了。后来chrome改成多进程，每个tab页面都有自己的渲染进程，一个崩溃也不影响其他tab页面。
目前的浏览器包括：1个浏览器主进程、1个GPU进程、1个网络进程、多个渲染进程和多个插件进程。
打开一个tab页面，会开一个渲染进程，这个渲染进程又有许多线程。

例外：
如果页面中插件，插件也有单独的进程
如果页面中iframe，iframe也会运行在单独的进程中
如果你装了扩展，扩展也会占用进程
如果两个页面属于同一个站点，并且B页面是从A页面中打开的，那么他们会共用一个渲染进程

> **进程**是CPU资源分配的最小单位；**线程**是CPU调度的最小单位

在chrome里，打开一个tab页面，会开一个渲染进程，一个渲染进程里有多个线程，比如js引擎线程、http请求线程、事件触发线程、GUI渲染线程等等。

由于单线程的原因，主线程在同一时间只能处理一件事。每处理完一个任务，会去消息队列里取下一个任务。

问：如果一个任务执行时间过长，怎么优化？
答：引入**异步编程**，实现**非阻塞**调用
同步任务会在调用栈中按照顺序来执行，异步任务会交给相应WebAPIs（DOM、ajax、setTimeout）线程去处理，在异步任务有结果时，把注册的回调函数放入任务队列中，等主线程空闲时（调用栈被清空），读取任务队列中的回调函数并执行。

问：多个任务，如何决定先执行那个？
答：引入**任务队列(task queue)**，按序

问：如果有紧急任务，怎么处理？
答：引入**宏任务**，**微任务**

## 事件循环

- 主线程执行栈
- WebAPIs
- 任务队列

js异步靠的是浏览器的多线程，当遇到异步任务时，将这个任务交给对应的线程。在这个异步任务有结果时，通过事件触发线程将这个事件放入任务队列，然后主线程执行完主线程任务后从任务队列中取出事件执行。

浏览器多线程，js是单线程的。

微任务是ES对异步的定义，宠任务是浏览器对异步的定义。

浏览器端事件循环中的异步队列有两种：宏任务队列、微任务队列

|  | 宏任务 | 微任务 |
| ---- | ---- | ---- |
| 谁发起的 | 浏览器、Node | javascript |
| 具体事件 | script(全局任务)，setTimeout，setInterval，setImmediate，I/O，UI rendering | process.nextTick，Promise的then和catch，Object.observer，MutationObserve |

在**事件循环**中，把一次循环称为一个tick，步骤：
1. 宏任务队列，执行一个宏任务
2. 执行函数调用栈，依次执行微任务队列中任务
3. 微任务队列清空后，查看是否有需要渲染的
4. 进入下一个tick, 执行下一个宏任务，重复上面步骤

未完待续